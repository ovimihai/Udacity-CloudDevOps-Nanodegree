# Design an Ansible Playbook

https://youtu.be/BB5aKlsYfo0

The command used in the demo above is similar to:
    
    ansible-playbook -i inventory.txt main.yml --private-key=~/udacity-ansible.pem 

Before you use the command above, go through the section below and change the name and path of the private key filename - _udacity-ansible.pem_.

## Ansible Playbook - Introduction
> 
> **Definition** - Playbooks are the YAML files containing a series of commands to run on the target machines.

Each Playbook contains the following primary sections:

* name - Name of the file.
* hosts - Identifies the target machines / hosts.
* tasks - Contains the ordered series of commands to run on the identified hosts. Sometimes, it contains Modules, which are like library functions.
* roles - These are self-conatined "child" Playbooks that are used to bring modularity in complex orchestration.

See an exmaple Playbook in the demo video below. You'll be creating lots of Playbooks from here on out! They're a large part of using Ansible to implement Continuous Delivery.

https://youtu.be/fDZ6d9L1ECQ

### 1\. Install Ansible

Refer to the official instructions available [here](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html).

### 2\. Authentication

Remember that Ansible is just executing bash commands over SSH, so whatever you need to log in to your instance manually, you will also need for Ansible.

There are two things we need to authenticate:

1. username
2. ssh key

The first component of authentication is the "username" of the user we will log in as. In most cases, you will use the default user for the EC2 instance. For example, if your instance was created using the Ubuntu AMI, then your default username is "ubuntu" according to [this page](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/connection-prereqs.html).
    
     user: ubuntu 

The second component of authentication is the SSH key, also known as the key pair or the PEM file. The SSH key would have been associated with our default user already. We need a copy of the SSH key in the form of a PEM file. We will refer to this PEM file when executing the playbook.

### 3\. Targets

You can target one or more machines with just one Ansible playlist. Each play in a Playbook should have a `hosts` section where you can select machines that you want to configure. You can specify one hostname, a group name, or use a pattern to select multiple hosts from an inventory list.
    
     hosts: web 

An inventory file can be very powerful and complex, but it can also be extremely simple. On the easy extreme, the inventory file is just a list of DNS hostnames or IP addresses in a group labeled by a `["group_name"]` in typical INI style. This is what it looks like.
    
    [web] ec2-50-16-166-50.compute-1.amazonaws.com 

Note that the `web` group name is being referred to in the Playbook `host` line. Have a look at the relevant references:

* [How to target different hosts?](https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html)
* [How to build an inventory file?](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html)

### 4\. Roles

In Ansible, roles are a great way to clean up your Ansible code and make it more maintainable. We can build roles by using Ansible's expected folder/file structure.
    
    ├── main1.yml # Playbook file (Ignore file name) └── roles ├── configure-prometheus-node-exporter │ └── tasks │ └── main.yml └── configure-server └── tasks └── main.yml 

The main playbook file and configure-server role files above also available here: [https://github.com/udacity/nd9991-c3-hello-world-exercise-solution](https://github.com/udacity/nd9991-c3-hello-world-exercise-solution) Here we have two roles:

1. configure-prometheus-node-exporter
2. configure-server\`

The sub-folders in each role folder represent a different function in the role:

| Role Component | Description                                             |
|----------------|---------------------------------------------------------|
| tasks          | Main list of tasks that the role executes               |
| files          | Files that the role deploys                             |
| handlers       | Handlers, which may be used within or outside this role |
| library        | Modules, which may be used within this role             |
| defaults       | Default variables for the role                          |
| vars           | Other variables for the role                            |
| templates      | Templates that the role deploys                         |
| meta           | Metadata for the role, including role dependencies      |

According to Ansible's rules, each sub-folder of each role must have a `main.yml` file in it, which is how it is able to discover and incorporate the role functionality.

We're going to mostly use `tasks` and `files`. If you want to know more about how to use the other components of Ansible roles, you should check out the docs.

Let's take a look at my task code.

Our `main.yml` playbook file:
    
    --- - name: "configuration play." hosts: web user: ubuntu gather_facts: false vars: - ansible_python_interpreter: /usr/bin/python3 - ansible_host_key_checking: false - ansible_stdout_callback: yaml pre_tasks: - name: "wait 600 seconds for target connection to become reachable/usable." wait_for_connection: - name: "install python for Ansible." become: true raw: test -e /usr/bin/python3 || (apt -y update && apt install -y python3) changed_when: false - setup: roles: - configure-prometheus-node-exporter - configure-server1 

> Be careful with the indentation of the YAML file above! It is possible that the indentation may get disturbed while copying-pasting.

You can find the main playbook file in the [Github](https://github.com/udacity/nd9991-c3-hello-world-exercise-solution/blob/main/main1.yml). _(Ignore the file name)._

Our `roles/configure-server/tasks/main.yml` file _(Roles)_:
    
    --- - name: "upgrade packages." become: true apt: upgrade: "yes" - name: "install dependencies." become: true apt: name: ["nodejs", "npm"] state: latest update_cache: yes - name: "install pm2" become: true npm: name: pm2 global: yes production: yes state: present 

The role file above can also be found here on [Github](https://github.com/udacity/nd9991-c3-hello-world-exercise-solution/blob/main/roles/configure-server/tasks/main.yml). Do not copy and use it straight-away. Instead, go through the individual statements. In my code above, you'll notice a few things:

* The playbook is the entry point
* The playbook delegates to roles by name
* The role does the actual work. You can probably guess what it's doing without much explanation.
* Each task is using `become: yes` to escalate to `root` user (like adding `sudo` before bash commands).

Read more about Ansible roles in [the documentation](https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html).

![Showing the contents of three files - playbook, tasks/main.yml, and inventory.txt](https://video.udacity-data.com/topher/2021/September/612f9951_ex1-code/ex1-code.png)

Showing the contents of three files - playbook, tasks/main.yml, and inventory.txt

### 5\. Modules

Ansible modules are the utilities that you can use in your Playbooks. Some of the Ansible modules are:

| Module    | Description                                               |
|-----------|-----------------------------------------------------------|
| shell     | How you execute shell commands and scripts                |
| apt       | Manage apt packages                                       |
| npm       | Manage nodejs packages                                    |
| file      | Set attributes of files and directories as well as remove |
| git       | Push and pull code and files from git                     |
| script    | Execute a shell script                                    |
| copy      | Copy files                                                |
| unarchive | Unpack an archive file                                    |
| systemd   | Manage services                                           |

You can see a list of all the modules in [the Ansible docs](https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html).

### 6\. Further Reading

* [What is an Ansible playbook?](https://www.redhat.com/en/topics/automation/what-is-an-ansible-playbook)
* [Learning Ansible terminology](https://www.redhat.com/en/topics/automation/learning-ansible-tutorial)